<html>
	<head>
		<style>
			body {
				background-color: darkgray;
			}
			
			table, td, th {
				border: 1px solid;
			}
		</style>
		<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
	</head>
	<body>
		<input type="text" id="itemId">
		<input type="text" id="world">
		<input type="text" id="region">

		<table id="data-table">
			<tr>
				<td>Image</td>
				<td>Name</td>
				<td>Amount</td>
				<td>Cheapest current price NQ (region)</td>
				<td>Cheapest current price HQ (region)</td>
				<td>Latest sale price NQ (world)</td>
				<td>Latest sale price HQ (world)</td>
			</tr>
		</table>
		
		<div id="error" style="color: red;"></div>
	</body>
</html>

<script>
$(document).ready(() => {
	$("#itemId").val(26782);
	$("#world").val("Louisoix");
	$("#region").val("Europe");
	init();
});

$("#itemId").change(() => {
	init();
});

async function init() {
	const error = $("#error");
	const itemId = $("#itemId").val();
	const world = $("#world").val();
	const region = $("#region").val();

	error.html("");

	try {
		const item = await fetchItem(itemId);
		console.log(item);
		
		const recipe = await fetchRecipe(item.Recipes[0].ID);
		console.log(recipe);

		const marketData = await fetchMarketDataForItem(region, itemId);
		console.log(marketData);

		let minListingNQ = marketData.listings
			.filter((listing) => listing.hq === false)
			.reduce((previous, current) => current.pricePerUnit < previous.pricePerUnit ? current : previous);

		let minListingHQ = marketData.listings
			.filter((listing) => listing.hq === true)
			.reduce((previous, current) => current.pricePerUnit < previous.pricePerUnit ? current : previous);

		let row = { item, recipe, minListingHQ, minListingNQ };
		console.log(row);

		drawItem(row);
		
		let ingredients = [];

		if (recipe.AmountResult) {
			let ingredientAmount = 0;
			let checking = true;

			while (checking) {
				if (recipe["AmountIngredient" + ingredientAmount] === undefined) {
					checking = false;
				} else if (recipe["AmountIngredient" + ingredientAmount]) {
					ingredients.push({ amount: recipe["AmountIngredient" + ingredientAmount], item: recipe["ItemIngredient" + ingredientAmount] });
				}

				ingredientAmount++;
			}
		} else {
			throw new Error("Item is not a recipe.");
		}
		
		console.log(ingredients);
		ingredients.forEach((item) => drawItem(item));
	} catch (ex) {
		error.html(ex);
	}
}

function drawItem(item) {
	let html = "";

	html += "<tr>";
	html += "<td><img src=\"" + "https://xivapi.com/" + item.item.Icon + "\"></td>";
	html += "<td>" + item.item.Name + "</td>";
	html += "<td>" + item.recipe.AmountResult + "</td>";
	html += "<td>" + item.minListingNQ + "</td>";
	html += "<td>" + item.minListingHQ + "</td>";
	html += "<td></td>";
	html += "<td></td>";
	html += "</tr>";

	$("#data-table").append(html);
}

function fetchMarketDataForItem(region, itemId) {
	return $.get("https://universalis.app/api/v2/" + region + "/" + itemId, (data) => data)
	.fail((error) => {
		throw new Error(error.Message);
	});
}

function fetchItem(itemId) {
	return $.get("https://xivapi.com/item/" + itemId, (item) => {
		if (item.Recipes) {
			return item;
		} else {
			throw new Error("Item is not a recipe.");
		}
	})
	.fail((error) => {
		throw new Error(error.Message);
	});
}

function fetchRecipe(recipeId) {
	return $.get("https://xivapi.com/recipe/" + recipeId, (recipe) => recipe)
	.fail((error) => {
		throw new Error(error.Message);
	});
}
</script>